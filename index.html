<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SMSD Tech Team Dashboard</title>
  <link rel="apple-touch-icon" sizes="180x180" href="https://cmd-q.net/Icons/apple_icon.png">
  <link rel="icon" type="image/png" href="Icons/dumpster.png?v=2">
  <link rel="shortcut icon" href="Icons/dumpster.png?v=2">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <link rel="stylesheet" href="dashboard.css">
</head>

<body data-theme="light" data-layout="medium" data-prefs="closed">
  <div class="midnight-noise" aria-hidden="true"></div>

  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="topbar-left"></div>

        <div class="topbar-center">
          <div class="brand">
            <div class="brand-badge">
              <img src="https://cmd-q.net/Icons/dumpster.png" alt="" aria-hidden="true">
            </div>
            <div class="brand-title">
              <strong>SMSD Tech Team Dashboard</strong>
            </div>
          </div>

          <div class="search" role="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input id="searchInput" type="search" placeholder="Search…" autocomplete="off" />
            <button class="search-clear" id="searchClear" type="button" aria-label="Clear search" title="Clear search">x</button>
          </div>
        </div>

        <div class="topbar-right">
          <div class="prefs-drawer" id="prefsDrawer">
            <button class="prefs-toggle" id="prefsToggle" type="button"
                    aria-expanded="false" aria-controls="prefsPanel"
                    title="Show/hide settings" aria-label="Show/hide settings">
              <span class="prefs-icon" aria-hidden="true">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                  <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.066 2.572c1.756.427 1.756 2.925 0 3.351a1.724 1.724 0 0 0-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0-2.572 1.066c-.427 1.756-2.925 1.756-3.351 0a1.724 1.724 0 0 0-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0-1.066-2.572c-1.756-.427-1.756-2.925 0-3.351a1.724 1.724 0 0 0 1.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="1.8"/>
                </svg>
              </span>
            </button>

            <div class="prefs-panel" id="prefsPanel" role="dialog" aria-label="Settings panel">
              <div class="controls">
                <div class="field">
                  <span class="chip" aria-hidden="true">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                      <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/>
                      <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </span>
                  <label for="themeSelect">Theme</label>
                  <select id="themeSelect" class="native-hidden" aria-hidden="true" tabindex="-1">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="midnight">Midnight</option>
                    <option value="chroma">Chroma</option>
                    <option value="sunset">Retrowave</option>
                  </select>
                  <div class="dropdown" data-dd="theme">
                    <button class="dd-trigger" id="themeTrigger" type="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="themeMenu">
                      <span class="dd-value">Light</span>
                    </button>
                    <div class="dd-menu" id="themeMenu" role="listbox" aria-label="Theme">
                      <button class="dd-option" type="button" role="option" data-value="light">Light</button>
                      <button class="dd-option" type="button" role="option" data-value="dark">Dark</button>
                      <button class="dd-option" type="button" role="option" data-value="midnight">Midnight</button>
                      <button class="dd-option" type="button" role="option" data-value="chroma">Chroma</button>
                      <button class="dd-option" type="button" role="option" data-value="sunset">Retrowave</button>
                    </div>
                  </div>
                </div>

                <div class="field">
                  <span class="chip" aria-hidden="true">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                      <path d="M4 6h7v12H4V6Z" stroke="currentColor" stroke-width="2"/>
                      <path d="M13 6h7v5h-7V6Z" stroke="currentColor" stroke-width="2"/>
                      <path d="M13 13h7v5h-7v-5Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                  </span>
                  <label for="layoutSelect">Layout</label>
                  <select id="layoutSelect" class="native-hidden" aria-hidden="true" tabindex="-1">
                    <option value="compact">Compact</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                  </select>
                  <div class="dropdown" data-dd="layout">
                    <button class="dd-trigger" id="layoutTrigger" type="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="layoutMenu">
                      <span class="dd-value">Medium</span>
                    </button>
                    <div class="dd-menu" id="layoutMenu" role="listbox" aria-label="Layout">
                      <button class="dd-option" type="button" role="option" data-value="compact">Compact</button>
                      <button class="dd-option" type="button" role="option" data-value="medium">Medium</button>
                      <button class="dd-option" type="button" role="option" data-value="large">Large</button>
                    </div>
                  </div>
                </div>

                <button class="palette-btn" id="paletteBtn" type="button" aria-label="Pick accent color" title="Pick accent color">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 22c5.523 0 10-4.03 10-9s-4.477-9-10-9S2 6.03 2 13c0 3.314 2.239 6 5 6h2c.552 0 1 .448 1 1v1c0 .552.448 1 1 1z" stroke="currentColor" stroke-width="2"/>
                    <circle cx="7.5" cy="11" r="1" fill="currentColor"/>
                    <circle cx="10.5" cy="8" r="1" fill="currentColor"/>
                    <circle cx="14.5" cy="8.5" r="1" fill="currentColor"/>
                    <circle cx="17" cy="11.5" r="1" fill="currentColor"/>
                  </svg>
                </button>
                <input class="accent-input" id="accentPicker" type="color" value="#9687cf" aria-label="Accent color">
                <button class="recent-toggle" id="recentToggle" type="button" aria-pressed="false" aria-label="Enable Recently Used row" title="Enable Recently Used row">
                  <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                    <rect x="3" y="3" width="7" height="7" rx="1.4"></rect>
                    <rect x="14" y="3" width="7" height="7" rx="1.4"></rect>
                    <rect x="3" y="14" width="7" height="7" rx="1.4"></rect>
                    <rect x="14" y="14" width="7" height="7" rx="1.4"></rect>
                  </svg>
                </button>
              </div>

              <button class="reset" id="resetPrefs" type="button"
                      title="Reset theme/layout/accent and saved ordering on this browser">
                Reset
              </button>
            </div>
          </div>
        </div>

      </div>
    </header>

    <main>
      <div class="quick-row" id="quickRow"></div>
      <div id="recentHost"></div>
      <div class="columns" id="columnsRoot"></div>
    </main>
    <div class="build-version" id="buildVersion" aria-hidden="true"></div>
  </div>

  <script>
  const QUICK_LINKS = [
    { id: 'bshs-switches', title: 'BSHS Switches', meta: '', href: 'https://cmd-q.net/BSHSSwitches.html', icon: 'server' },
    { id: 'ybms-switches', title: 'YBMS Switches', meta: '', href: 'https://cmd-q.net/YBMSSwitches.html', icon: 'server' },
    { id: 'ifes-switches', title: 'IFES Switches', meta: '', href: 'https://cmd-q.net/IFESSwitches.html', icon: 'server' },
    { id: 'rice-switches', title: 'Rice Switches', meta: '', href: 'https://cmd-q.net/RiceSwitches.html', icon: 'server' }
  ];

  const CATEGORIES = [
    {
      name: "Ticketing & Team", icon: "users", color: "#4fb3a8",
      items: [
        { id: 'helpdesk', title: 'Helpdesk', meta: 'Unresolved tickets', href: 'https://support.smsd.us/a/tickets/filters/search?label=Unresolved%20tickets&orderBy=created_at&orderType=desc&q[]=status%3A%5B0%5D&ref=unresolved', img: 'https://cmd-q.net/Icons/freshdesk.png' },
        { id: 'tech-team-site', title: 'Tech Team Site', meta: 'Teams channel', href: 'https://teams.microsoft.com/_#/school/conversations/General?threadId=19:2f3862a9ffd54c86993615905f54019a@thread.skype&ctx=channel', img: 'https://cmd-q.net/Icons/teams.png' },
        { id: 'myglue', title: 'MyGlue', meta: 'Docs & passwords', href: 'https://app.myglue.com/', img: 'https://cmd-q.net/Icons/Myglue.png' },
        { id: 'planner', title: 'Planner', meta: 'Tasks & boards', href: 'https://planner.cloud.microsoft', img: 'https://cmd-q.net/Icons/Planner.png' },
        { id: 'invoice', title: 'Student Invoice Sheet', meta: 'SharePoint spreadsheet', href: 'https://southmiddleton.sharepoint.com/:x:/r/sites/BoilingSpringsSchoolDistrict/_layouts/15/doc2.aspx?sourcedoc=%7B1F342A92-8DEF-4F37-9403-528DEB08D945%7D&file=Student%20technology%20invoice%20sheet.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1&cid=93745ffc-8857-48dd-9ac2-dc198f12cc7b', img: 'https://cmd-q.net/Icons/laptop.png' }
      ]
    },
    {
      name: "Microsoft Admin", icon: "shield", color: "#6aa6ff",
      items: [
        { id: 'intune', title: 'Intune', meta: 'Device management', href: 'https://intune.microsoft.com/#home', img: 'https://cmd-q.net/Icons/microsoft-intune.png' },
        { id: 'entra', title: 'Entra Admin', meta: 'Identity & access', href: 'https://entra.microsoft.com/', img: 'https://cmd-q.net/Icons/AAD.svg' },
        { id: 'exchange', title: 'Exchange Admin', meta: 'Mail flow & policies', href: 'https://admin.exchange.microsoft.com', img: 'https://cmd-q.net/Icons/Exchange.svg' },
        { id: 'azure', title: 'Azure Portal', meta: 'Cloud resources', href: 'https://portal.azure.com/#home', img: 'https://cmd-q.net/Icons/azure.png' },
        { id: 'intune-ed', title: 'Intune Education', meta: 'Education policies', href: 'https://intuneeducation.portal.azure.com', img: 'https://cmd-q.net/Icons/intuneeducation.png' },
        { id: 'ms-admin', title: 'Microsoft Admin Center', meta: 'Tenant admin', href: 'https://admin.microsoft.com', img: 'https://cmd-q.net/Icons/MSAdmin.svg' }
      ]
    },
    {
      name: "Security", icon: "lock", color: "#a78bfa",
      items: [
        { id: 'contentkeeper', title: 'ContentKeeper', meta: 'Filtering console', href: 'https://filter.smsd.local/ck/#/login', img: 'https://cmd-q.net/Icons/contentkeeper.png' },
        { id: 'mimecast', title: 'Mimecast', meta: 'Email security', href: 'https://login.mimecast.com', img: 'https://cmd-q.net/Icons/mimecast.png' },
        { id: 'sentinelone', title: 'SentinelOne', meta: 'EDR console', href: 'https://usea1-paiu.sentinelone.net/login', img: 'https://cmd-q.net/Icons/SentinelOne.png' },
        { id: 'defender', title: 'Defender Portal', meta: 'Security center', href: 'https://security.microsoft.com/', img: 'https://cmd-q.net/Icons/defender.png' },
        { id: 'genetec', title: 'Genetec', meta: 'Security Desk', href: 'https://bshs-cameraserv/WebApp/', img: 'https://cmd-q.net/Icons/genetec.png' }
      ]
    },
    {
      name: "Network & Monitoring", icon: "activity", color: "#5ee3a1",
      items: [
        { id: 'meraki', title: 'Meraki Dashboard', meta: 'Network & MDM', href: 'https://n21.meraki.com/Systems-Manager/n/kM3LDav/manage/pcc/list', img: 'https://cmd-q.net/Icons/Meraki.png' },
        { id: 'lansweeper', title: 'Lansweeper', meta: 'Asset inventory', href: 'http://lansweeper.smsd.us:81/default.aspx', img: 'https://cmd-q.net/Icons/lansweeper.png' },
        { id: 'auvik', title: 'Auvik', meta: 'Network monitoring', href: 'https://smsd.us1.my.auvik.com/#entity/root/dashboard', img: 'https://cmd-q.net/Icons/auvikedited.png' },
        { id: 'unifi', title: 'Ubiquiti UniFi', meta: 'Cloud console', href: 'https://unifi.ui.com/', img: 'https://cmd-q.net/Icons/unifi.png' },
        { id: 'uisp', title: 'Ubiquiti UISP', meta: 'Network management', href: 'https://smsd.uisp.com/nms/devices/', img: 'https://cmd-q.net/Icons/uisp.png' },
        { id: 'meraki-ap', title: 'Meraki AP Info', meta: 'Local AP page', href: 'http://10.128.128.126/#connection', img: 'https://cmd-q.net/Icons/Wifi.png' }
      ]
    },
    {
      name: "Infrastructure", icon: "server", color: "#ffd166",
      items: [
        { id: 'connectwise', title: 'ConnectWise', meta: 'Remote access', href: 'https://smsd.screenconnect.com/Host#Access', img: 'https://cmd-q.net/Icons/Connectwise.png' },
        { id: 'vsphere', title: 'vSphere', meta: 'Virtual infrastructure', href: 'https://vcsa.smsd.local/ui/', img: 'https://cmd-q.net/Icons/vmware.png' },
        { id: 'synology', title: 'Synology NAS', meta: 'Storage console', href: 'https://172.18.8.9', img: 'https://cmd-q.net/Icons/Synology.png' },
        { id: 'barracuda', title: 'Barracuda Backup', meta: 'Backup status', href: 'https://backup.barracudanetworks.com/all/status/', img: 'https://cmd-q.net/Icons/barracuda.png' },
        { id: 'fortivoice', title: 'FortiVoice', meta: 'Telephony admin', href: 'https://fortivoice.smsd.local/admin/AdminLogin.html', img: 'https://cmd-q.net/Icons/fortivoice.png' }
      ]
    },
    {
      name: "School Ops", icon: "book", color: "#ff6b9a",
      items: [
        { id: 'google-admin', title: 'Google Admin', meta: 'Directory, devices, apps', href: 'https://admin.google.com/?pli=1', img: 'https://cmd-q.net/Icons/GoogleAdmin.png' },
        { id: 'sapphire', title: 'Sapphire Suite', meta: 'Gradebook / SIS', href: 'https://smsd-sapphire.k12system.com/Gradebook/main.cfm', img: 'https://cmd-q.net/Icons/Sapphire.png' },
        { id: 'apple-school', title: 'Apple School Manager', meta: 'Devices & accounts', href: 'https://school.apple.com/', img: 'https://cmd-q.net/Icons/Apple.png' },
        { id: 'clever', title: 'Clever Admin', meta: 'SSO / rostering', href: 'https://clever.com/oauth/district_admin/login?target=%3BbzRrcGh2aDJ5Z252eDgzdnhjNjQ%3D%3BaHR0cHM6Ly9zY2hvb2xzLmNsZXZlci5jb20vYXV0aC1jYWxsYmFjaw%3D%3D%3BNmNhMWZlZWNmZDQyNDA4NjRhMDE3YzU5NDUxZTUzMTgzMjg3OGE1NTIxOTZiZWU0M2UxZDZjOGU2ZTc0ZDZiZQ%3D%3D%3BY29kZQ%3D%3D%3BZGlzdHJpY3RfYWRtaW4%3D', img: 'https://cmd-q.net/Icons/clever.png' },
        { id: 'papercut', title: 'Papercut', meta: 'Print management', href: 'http://papercut.smsd.local:9191/admin', img: 'https://cmd-q.net/Icons/papercutnewlogo.webp' },
        { id: 'revtrak', title: 'RevTrak', meta: 'Payments', href: 'https://smsdpa.revtrak.net/Portal/', img: 'https://cmd-q.net/Icons/revtrak.png' },
        { id: 'calendar', title: '2025–26 Calendar', meta: 'Instructional calendar (PDF)', href: 'https://cdnsm5-ss13.sharpschool.com/UserFiles/Servers/Server_297173/File/Calendars/2025%202026%20SMSD%20Instructional%20Calendar%201.13.25%202.pdf', img: 'https://cmd-q.net/Icons/calendar.png' },
        { id: 'smsd', title: 'SMSD Homepage', meta: 'Public site', href: 'https://smsd.us/', img: 'https://cmd-q.net/Icons/smsd.png' }
      ]
    },
    {
      name: "Vendors & Licensing", icon: "tag", color: "#7cf0ff",
      items: [
        { id: 'csiu', title: 'Employee Portal', meta: 'CSIU', href: 'https://fis5.csiu-technology.org/SMID/Account/LogOn', img: 'https://cmd-q.net/Icons/csiu.png' },
        { id: 'adobe', title: 'Adobe Admin', meta: 'Licensing & users', href: 'https://adminconsole.adobe.com/61C057945F0DB98A0A495FF5@AdobeOrg/overview', img: 'https://cmd-q.net/Icons/adobe.png' },
        { id: 'caiu', title: 'CAIU Helpdesk', meta: 'Support portal', href: 'https://caiu.myportallogin.com/', img: 'https://cmd-q.net/Icons/CAIU.png' },
        { id: 'pisignage', title: 'piSignage', meta: 'Digital signage', href: 'https://pisignage.com/', img: 'https://cmd-q.net/Icons/pisignage.png' },
        { id: 'triton', title: 'Triton Sensors', meta: 'Monitoring', href: 'https://app.tritonsensors.com/auth/login', img: 'https://cmd-q.net/Icons/triton.png' },
        { id: 'vls', title: 'Volume Licensing', meta: 'Keys, downloads', href: 'https://www.microsoft.com/licensing/ServiceCenter/default.aspx', img: 'https://cmd-q.net/Icons/VPP.png' },
        { id: 'savvas', title: 'Savvas', meta: 'SSO', href: 'https://sso.rumba.pk12ls.com/sso/login', img: 'https://cmd-q.net/Icons/savvas.png' },
        { id: 'kajeet', title: 'Kajeet Portal', meta: 'Filtering / devices', href: 'https://sentinel.kajeet.com/auth/login', img: 'https://cmd-q.net/Icons/kajeet.png' }
      ]
    }
  ];

  const ICON_SVGS = (() => {
    const common = 'fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
    return {
      users: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
      shield: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
      lock: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><rect x="3" y="11" width="18" height="11" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`,
      activity: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><path d="M22 12h-4l-3 9-4-18-3 9H2"/></svg>`,
      recents: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><rect x="3" y="10" width="11" height="11" rx="2"></rect><rect x="9" y="6" width="8" height="8" rx="2" opacity=".72"></rect><rect x="14" y="3" width="5" height="5" rx="1.5" opacity=".45"></rect></svg>`,
      server: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><rect x="2" y="3" width="20" height="8" rx="2"></rect><rect x="2" y="13" width="20" height="8" rx="2"></rect><path d="M6 7h.01M6 17h.01"/></svg>`,
      book: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
      tag: `<svg width="20" height="20" viewBox="0 0 24 24" ${common}><path d="M20.59 13.41 11 3H4v7l9.59 9.59a2 2 0 0 0 2.83 0l4.17-4.17a2 2 0 0 0 0-2.83z"></path><path d="M7 7h.01"></path></svg>`
    };
  })();

  const STORAGE = {
    theme: 'smsd-theme-v5',
    accent: 'smsd-accent-v5',
    accentByTheme: 'smsd-accent-by-theme-v1',
    layout: 'smsd-layout-v5',
    order: 'smsd-order-v5',
    quickOrder: 'smsd-quick-v5',
    recent: 'smsd-recent-v1',
    recentVisible: 'smsd-recent-visible-v1',
    prefsCollapsed: 'smsd-prefs-collapsed-v1'
  };
  const REPO_VERSION = '263';
  const REPO_DATE = '2.21.26';

  const el = {
    topbarInner: document.querySelector('.topbar-inner'),
    topbarRight: document.querySelector('.topbar-right'),
    searchBox: document.querySelector('.search'),
    quickRow: document.getElementById('quickRow'),
    columnsRoot: document.getElementById('columnsRoot'),
    searchInput: document.getElementById('searchInput'),
    searchClear: document.getElementById('searchClear'),
    resetPrefs: document.getElementById('resetPrefs'),
    themeSelect: document.getElementById('themeSelect'),
    layoutSelect: document.getElementById('layoutSelect'),
    paletteBtn: document.getElementById('paletteBtn'),
    accentPicker: document.getElementById('accentPicker'),
    prefsToggleBtn: document.getElementById('prefsToggle'),
    prefsDrawerEl: document.getElementById('prefsDrawer'),
    prefsPanelEl: document.getElementById('prefsPanel'),
    themeTrigger: document.getElementById('themeTrigger'),
    themeMenu: document.getElementById('themeMenu'),
    layoutTrigger: document.getElementById('layoutTrigger'),
    layoutMenu: document.getElementById('layoutMenu'),
    recentToggleBtn: document.getElementById('recentToggle'),
    recentHost: document.getElementById('recentHost'),
    buildVersion: document.getElementById('buildVersion')
  };
  if (el.buildVersion) el.buildVersion.textContent = `v${REPO_VERSION} ${REPO_DATE}`;

  let orderByCat = {};
  let quickOrder = [];
  let accentByTheme = {};
  let recentIds = [];
  let showRecent = false;
  let reorderCleanups = [];
  let suppressTileClickUntil = 0;
  let prefsAutoCloseTimer = null;
  const dropdownState = { openMenu: null };
  const RECENT_LIMIT = 8;
  const ITEM_BY_ID = (() => {
    const map = new Map();
    for (const cat of CATEGORIES) {
      for (const item of cat.items) map.set(item.id, { ...item, _category: cat.name });
    }
    return map;
  })();

  const readJSON = (key, fallback) => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch {
      return fallback;
    }
  };

  const setAttr = (node, name, value) => node?.setAttribute(name, value);

  const normalizeTheme = (value) => (value === 'frost' ? 'chroma' : value);

  const closeDropdowns = () => {
    document.querySelectorAll('.dropdown[data-open="true"]').forEach(dd => dd.setAttribute('data-open', 'false'));
    if (el.themeTrigger) el.themeTrigger.setAttribute('aria-expanded', 'false');
    if (el.layoutTrigger) el.layoutTrigger.setAttribute('aria-expanded', 'false');
    dropdownState.openMenu = null;
  };

  const syncDropdown = (selectEl, triggerEl, menuEl) => {
    if (!selectEl || !triggerEl || !menuEl) return;
    const selected = selectEl.options[selectEl.selectedIndex];
    const valueEl = triggerEl.querySelector('.dd-value');
    if (valueEl) valueEl.textContent = selected ? selected.text : '';
    menuEl.querySelectorAll('.dd-option').forEach(btn => {
      const isSelected = btn.getAttribute('data-value') === selectEl.value;
      btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
      btn.classList.toggle('is-selected', isSelected);
    });
  };

  const setupDropdown = (selectEl, triggerEl, menuEl) => {
    if (!selectEl || !triggerEl || !menuEl) return;
    const root = triggerEl.closest('.dropdown');

    triggerEl.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = root?.getAttribute('data-open') === 'true';
      closeDropdowns();
      if (!isOpen) {
        root?.setAttribute('data-open', 'true');
        triggerEl.setAttribute('aria-expanded', 'true');
        dropdownState.openMenu = menuEl.id;
      }
    });

    menuEl.addEventListener('click', (e) => {
      const opt = e.target.closest('.dd-option');
      if (!opt) return;
      e.stopPropagation();
      const value = opt.getAttribute('data-value');
      if (!value) return;
      if (selectEl.value !== value) {
        selectEl.value = value;
        selectEl.dispatchEvent(new Event('change', { bubbles: true }));
      }
      syncDropdown(selectEl, triggerEl, menuEl);
      closeDropdowns();
    });
  };

  const applyAccent = (hex) => {
    document.documentElement.style.setProperty('--accent', hex);
    if (el.accentPicker) el.accentPicker.value = hex;
  };
  const defaultAccentForTheme = (theme) => {
    if (theme === 'dark') return '#5E81AC';
    if (theme === 'chroma') return '#88c0d0';
    if (theme === 'sunset') return '#f80278';
    return '#9687cf';
  };

  const iconSVG = (name) => ICON_SVGS[name] || ICON_SVGS.tag;

  const applySavedOrder = (items, savedIds) => {
    if (!Array.isArray(savedIds) || savedIds.length === 0) return items;
    const byId = new Map(items.map(i => [i.id, i]));
    const used = new Set();
    const out = [];

    for (const id of savedIds) {
      const hit = byId.get(id);
      if (hit) {
        out.push(hit);
        used.add(id);
      }
    }
    for (const it of items) {
      if (!used.has(it.id)) out.push(it);
    }
    return out;
  };

  const normalizeRecent = (value) => {
    if (!Array.isArray(value)) return [];
    const out = [];
    const seen = new Set();
    for (const id of value) {
      if (!ITEM_BY_ID.has(id) || seen.has(id)) continue;
      seen.add(id);
      out.push(id);
      if (out.length >= RECENT_LIMIT) break;
    }
    return out;
  };

  const trackRecent = (id) => {
    if (!id || !ITEM_BY_ID.has(id)) return;
    recentIds = [id, ...recentIds.filter(x => x !== id)].slice(0, RECENT_LIMIT);
    localStorage.setItem(STORAGE.recent, JSON.stringify(recentIds));
  };

  const setRecentVisible = (visible) => {
    showRecent = !!visible;
    localStorage.setItem(STORAGE.recentVisible, showRecent ? '1' : '0');
    if (el.recentToggleBtn) {
      el.recentToggleBtn.setAttribute('data-on', showRecent ? 'true' : 'false');
      el.recentToggleBtn.setAttribute('aria-pressed', showRecent ? 'true' : 'false');
      el.recentToggleBtn.setAttribute('aria-label', showRecent ? 'Disable Recently Used row' : 'Enable Recently Used row');
      el.recentToggleBtn.setAttribute('title', showRecent ? 'Disable Recently Used row' : 'Enable Recently Used row');
    }
  };

  const tileHTML = (item, scopeName) => {
    const titleKey = `${item.title} ${item.meta || ''} ${scopeName}`.toLowerCase();
    const singleLong = !item.title.includes(' ') && item.title.length > 12;
    const iconMarkup = item.icon
      ? iconSVG(item.icon)
      : `<img src="${item.img}" alt="${item.title}" loading="lazy" decoding="async">`;
    return `
      <a class="tile" href="${item.href}" data-id="${item.id}" data-scope="${scopeName}" data-title="${titleKey}" draggable="false">
        <div class="tile-icon">${iconMarkup}</div>
        <div class="tile-text">
          <div class="tile-title${singleLong ? ' single-long' : ''}">${item.title}</div>
          <div class="tile-meta">${item.meta || ''}</div>
        </div>
      </a>
    `;
  };

  const destroyReorder = () => {
    for (const off of reorderCleanups) off();
    reorderCleanups = [];
    document.body.classList.remove('reorder-dragging');
  };

  const animateReflow = (container, mutate) => {
    const moving = [...container.querySelectorAll('.tile:not(.is-dragging):not(.tile-placeholder)')];
    const first = new Map(moving.map(node => [node, node.getBoundingClientRect()]));
    mutate();
    for (const node of moving) {
      const prev = first.get(node);
      if (!prev) continue;
      const next = node.getBoundingClientRect();
      const dx = prev.left - next.left;
      const dy = prev.top - next.top;
      if (Math.abs(dx) < 1 && Math.abs(dy) < 1) continue;
      node.style.transition = 'none';
      node.style.transform = `translate(${dx}px, ${dy}px)`;
      requestAnimationFrame(() => {
        node.style.transition = 'transform 280ms cubic-bezier(0.22, 1, 0.36, 1)';
        node.style.transform = '';
      });
    }
  };

  const bindContainerReorder = (container, onCommit) => {
    if (!container) return () => {};
    let pointerId = null;
    let startX = 0;
    let startY = 0;
    let sourceTile = null;
    let pressTimer = null;
    let drag = null;

    const clearPressTimer = () => {
      if (!pressTimer) return;
      clearTimeout(pressTimer);
      pressTimer = null;
    };

    const cleanupInlineDragStyles = () => {
      if (!sourceTile) return;
      sourceTile.classList.remove('is-dragging');
      sourceTile.style.position = '';
      sourceTile.style.left = '';
      sourceTile.style.top = '';
      sourceTile.style.width = '';
      sourceTile.style.height = '';
      sourceTile.style.margin = '';
      sourceTile.style.zIndex = '';
      sourceTile.style.pointerEvents = '';
      sourceTile.style.opacity = '';
      sourceTile.style.transform = '';
      sourceTile.style.transition = '';
      sourceTile.style.clipPath = '';
      sourceTile.style.webkitClipPath = '';
    };

    const resolveTargetTile = (clientX, clientY) => {
      const probe = document.elementFromPoint(clientX, clientY);
      const direct = probe?.closest('.tile');
      if (direct && direct.parentElement === container && direct !== sourceTile && direct !== drag?.placeholder) {
        return direct;
      }
      const candidates = [...container.querySelectorAll('.tile:not(.is-dragging):not(.tile-placeholder)')];
      if (!candidates.length) return null;
      const useHorizontal = container.classList.contains('quick-row');
      let best = candidates[0];
      let bestDist = Number.POSITIVE_INFINITY;
      for (const node of candidates) {
        const r = node.getBoundingClientRect();
        const cx = r.left + (r.width / 2);
        const cy = r.top + (r.height / 2);
        const d = useHorizontal ? Math.abs(clientX - cx) : Math.abs(clientY - cy);
        if (d < bestDist) {
          bestDist = d;
          best = node;
        }
      }
      return best;
    };

    const placeDraggedTile = (clientX, clientY) => {
      if (!drag || !sourceTile) return;
      const hostRect = container.getBoundingClientRect();
      const left = clientX - hostRect.left - drag.offsetX;
      const top = clientY - hostRect.top - drag.offsetY;
      sourceTile.style.left = `${left}px`;
      sourceTile.style.top = `${top}px`;
    };

    const movePlaceholder = (clientX, clientY) => {
      if (!drag || !sourceTile) return;
      const placeholder = drag.placeholder;
      const target = resolveTargetTile(clientX, clientY);
      if (!target) return;

      const rect = target.getBoundingClientRect();
      const useHorizontal = container.classList.contains('quick-row');
      const before = useHorizontal
        ? clientX < (rect.left + rect.width / 2)
        : clientY < (rect.top + rect.height / 2);

      if (before && placeholder.nextSibling === target) return;
      if (!before && target.nextSibling === placeholder) return;

      animateReflow(container, () => {
        container.insertBefore(placeholder, before ? target : target.nextSibling);
      });
      drag.moved = true;
    };

    const finishDrag = (commit) => {
      clearPressTimer();
      window.removeEventListener('pointermove', onPointerMove, { capture: true });
      window.removeEventListener('pointerup', onPointerUp, { capture: true });
      window.removeEventListener('pointercancel', onPointerCancel, { capture: true });

      if (drag && sourceTile) {
        if (drag.placeholder.parentElement === container) {
          drag.placeholder.replaceWith(sourceTile);
        } else {
          container.appendChild(sourceTile);
        }
        if (drag.parentRestore && sourceTile.parentElement !== drag.parentRestore) {
          drag.parentRestore.appendChild(sourceTile);
        }
        cleanupInlineDragStyles();
        drag = null;
        if (commit) onCommit();
      } else if (drag?.placeholder) {
        drag.placeholder.remove();
        drag = null;
      }

      pointerId = null;
      sourceTile = null;
      document.body.classList.remove('reorder-dragging');
    };

    const startDrag = (event) => {
      if (!sourceTile || drag) return;
      const rect = sourceTile.getBoundingClientRect();
      const placeholder = document.createElement('div');
      placeholder.className = 'tile tile-placeholder';
      placeholder.style.width = `${rect.width}px`;
      placeholder.style.height = `${rect.height}px`;
      placeholder.style.minHeight = `${rect.height}px`;

      sourceTile.after(placeholder);
      const hostRect = container.getBoundingClientRect();
      sourceTile.classList.add('is-dragging');
      container.appendChild(sourceTile);
      sourceTile.style.position = 'absolute';
      sourceTile.style.left = `${rect.left - hostRect.left}px`;
      sourceTile.style.top = `${rect.top - hostRect.top}px`;
      sourceTile.style.width = `${rect.width}px`;
      sourceTile.style.height = `${rect.height}px`;
      sourceTile.style.margin = '0';
      sourceTile.style.zIndex = '4000';
      sourceTile.style.pointerEvents = 'none';
      sourceTile.style.opacity = '1';
      sourceTile.style.transition = 'none';
      sourceTile.style.transform = 'none';

      drag = {
        placeholder,
        parentRestore: container,
        offsetX: event.clientX - rect.left,
        offsetY: event.clientY - rect.top,
        moved: false
      };
      document.body.classList.add('reorder-dragging');
      placeDraggedTile(event.clientX, event.clientY);
    };

    const onPointerMove = (event) => {
      if (event.pointerId !== pointerId || !sourceTile) return;
      const moved = Math.hypot(event.clientX - startX, event.clientY - startY);

      if (!drag) {
        if (event.pointerType === 'touch') {
          if (moved > 10) {
            clearPressTimer();
            finishDrag(false);
            return;
          }
          return;
        }
        if (moved > 4) startDrag(event);
        return;
      }

      event.preventDefault();
      placeDraggedTile(event.clientX, event.clientY);
      movePlaceholder(event.clientX, event.clientY);
    };

    const onPointerUp = (event) => {
      if (event.pointerId !== pointerId) return;
      if (drag) {
        event.preventDefault();
        suppressTileClickUntil = Date.now() + 450;
        finishDrag(true);
        return;
      }
      finishDrag(false);
    };

    const onPointerCancel = (event) => {
      if (event.pointerId !== pointerId) return;
      finishDrag(false);
    };

    const onPointerDown = (event) => {
      const tile = event.target.closest('.tile');
      if (!tile || tile.parentElement !== container) return;
      if (event.pointerType === 'mouse' && event.button !== 0) return;

      pointerId = event.pointerId;
      sourceTile = tile;
      startX = event.clientX;
      startY = event.clientY;

      clearPressTimer();
      const holdMs = event.pointerType === 'touch' ? 100 : null;
      if (holdMs !== null) {
        pressTimer = setTimeout(() => startDrag(event), holdMs);
      }

      window.addEventListener('pointermove', onPointerMove, { capture: true });
      window.addEventListener('pointerup', onPointerUp, { capture: true });
      window.addEventListener('pointercancel', onPointerCancel, { capture: true });
    };

    container.addEventListener('pointerdown', onPointerDown, { passive: true });
    return () => {
      clearPressTimer();
      container.removeEventListener('pointerdown', onPointerDown);
      window.removeEventListener('pointermove', onPointerMove, { capture: true });
      window.removeEventListener('pointerup', onPointerUp, { capture: true });
      window.removeEventListener('pointercancel', onPointerCancel, { capture: true });
    };
  };

  const enableReorder = () => {
    destroyReorder();

    reorderCleanups.push(bindContainerReorder(el.quickRow, () => {
      quickOrder = [...el.quickRow.querySelectorAll('.tile')].map(t => t.getAttribute('data-id'));
      localStorage.setItem(STORAGE.quickOrder, JSON.stringify(quickOrder));
    }));

    document.querySelectorAll('.cat-body').forEach(body => {
      if (body.getAttribute('data-static') === 'true') return;
      const catName = body.getAttribute('data-cat-body');
      reorderCleanups.push(bindContainerReorder(body, () => {
        orderByCat[catName] = [...body.querySelectorAll('.tile')].map(t => t.getAttribute('data-id'));
        localStorage.setItem(STORAGE.order, JSON.stringify(orderByCat));
      }));
    });
  };

  const recentTileHTML = (item) => {
    const titleKey = `${item.title} ${item.meta || ''} ${item._category || 'recent'}`.toLowerCase();
    const iconMarkup = item.icon
      ? iconSVG(item.icon)
      : `<img src="${item.img}" alt="${item.title}" loading="lazy" decoding="async">`;
    return `
      <a class="tile recent-tile" href="${item.href}" data-id="${item.id}" data-scope="recent" data-title="${titleKey}" title="${item.title}" draggable="false">
        <div class="tile-icon">${iconMarkup}</div>
        <div class="tile-text">
          <div class="tile-title">${item.title}</div>
        </div>
      </a>
    `;
  };

  const applyFilter = () => {
    const q = (el.searchInput?.value || '').trim().toLowerCase();

    let quickAny = false;
    el.quickRow.querySelectorAll('.tile').forEach(tile => {
      const hay = `${tile.getAttribute('data-title') || ''} ${tile.textContent || ''}`.toLowerCase();
      const ok = hay.includes(q);
      tile.style.display = ok ? '' : 'none';
      if (ok) quickAny = true;
    });

    el.quickRow.style.display = (q && !quickAny) ? 'none' : 'flex';

    document.querySelectorAll('.category').forEach(catEl => {
      const isStatic = catEl.getAttribute('data-static') === 'true';
      let any = false;
      catEl.querySelectorAll('.tile').forEach(tile => {
        const hay = `${tile.getAttribute('data-title') || ''} ${tile.textContent || ''}`.toLowerCase();
        const ok = hay.includes(q);
        tile.style.display = ok ? '' : 'none';
        if (ok) any = true;
      });
      catEl.hidden = isStatic ? false : !any;
    });
  };

  const syncPrefsAnchor = () => {
    if (window.matchMedia('(max-width: 980px)').matches) {
      document.documentElement.style.setProperty('--prefs-nudge', '0px');
      return;
    }
    const topbarRight = el.topbarRight;
    const topbarInner = el.topbarInner;
    const root = el.columnsRoot;
    if (!topbarRight || !topbarInner || !root) return;

    const cats = [...root.querySelectorAll('.category:not(.category-recent):not([hidden])')];
    if (!cats.length) {
      document.documentElement.style.setProperty('--prefs-nudge', '0px');
      return;
    }

    let maxRight = 0;
    for (const c of cats) {
      const r = c.getBoundingClientRect().right;
      if (r > maxRight) maxRight = r;
    }
    const innerRight = topbarInner.getBoundingClientRect().right;
    const nudge = Math.max(0, Math.round(innerRight - maxRight));
    document.documentElement.style.setProperty('--prefs-nudge', `${nudge}px`);
  };

  const render = () => {
    const qItems = applySavedOrder([...QUICK_LINKS], quickOrder);
    el.quickRow.innerHTML = qItems.map(it => tileHTML(it, 'quick')).join('');

    if (el.recentHost) el.recentHost.innerHTML = '';
    el.columnsRoot.innerHTML = '';
    const recentItems = recentIds.map(id => ITEM_BY_ID.get(id)).filter(Boolean);
    const mobileRecent = window.matchMedia('(max-width: 720px)').matches;
    const visibleRecentItems = mobileRecent ? recentItems.slice(0, 4) : recentItems;
    if (showRecent) {
      const recentCols = mobileRecent
        ? 4
        : Math.min(RECENT_LIMIT, Math.max(4, visibleRecentItems.length || 0));
      const recentSection = document.createElement('section');
      recentSection.className = 'category category-recent';
      recentSection.style.setProperty('--cat-color', '#53f5ff');
      recentSection.style.setProperty('--recent-cols', String(recentCols));
      recentSection.setAttribute('data-category', 'Recently Used');
      recentSection.setAttribute('data-static', 'true');
      recentSection.innerHTML = `
        <div class="cat-head">
          <div class="cat-left">
            <div class="cat-icon" aria-hidden="true">${iconSVG('recents')}</div>
            <div class="cat-title" title="Recents">Recents</div>
          </div>
        </div>
        <div class="cat-body" data-cat-body="__recent__" data-static="true">
          ${visibleRecentItems.length
            ? visibleRecentItems.map(it => recentTileHTML(it)).join('')
            : '<div class="recent-empty">Open links and they will show up here.</div>'}
        </div>
      `;
      if (el.recentHost) {
        el.recentHost.appendChild(recentSection);
      } else {
        el.columnsRoot.appendChild(recentSection);
      }
    }

    for (const cat of CATEGORIES) {
      const items = applySavedOrder([...cat.items], orderByCat[cat.name]);
      const section = document.createElement('section');

      section.className = 'category';
      section.style.setProperty('--cat-color', cat.color);
      section.setAttribute('data-category', cat.name);
      section.innerHTML = `
        <div class="cat-head">
          <div class="cat-left">
            <div class="cat-icon" aria-hidden="true">${iconSVG(cat.icon)}</div>
            <div class="cat-title" title="${cat.name}">${cat.name}</div>
          </div>
        </div>
        <div class="cat-body" data-cat-body="${cat.name}">
          ${items.map(it => tileHTML(it, cat.name)).join('')}
        </div>
      `;

      el.columnsRoot.appendChild(section);
    }

    enableReorder();
    applyFilter();
    requestAnimationFrame(syncPrefsAnchor);
  };

  const pickDefaultLayoutIfUnset = () => {
    if (localStorage.getItem(STORAGE.layout)) return;
    const isMobile = window.matchMedia('(max-width: 720px)').matches;
    localStorage.setItem(STORAGE.layout, isMobile ? 'compact' : 'medium');
  };

  const setPrefsOpen = (open) => {
    if (prefsAutoCloseTimer) {
      clearTimeout(prefsAutoCloseTimer);
      prefsAutoCloseTimer = null;
    }
    if (!open) closeDropdowns();
    setAttr(document.body, 'data-prefs', open ? 'open' : 'closed');
    setAttr(el.prefsToggleBtn, 'aria-expanded', open ? 'true' : 'false');
    localStorage.setItem(STORAGE.prefsCollapsed, open ? '0' : '1');
  };

  const schedulePrefsAutoClose = () => {
    if (document.body.getAttribute('data-prefs') !== 'open') return;
    if (prefsAutoCloseTimer) clearTimeout(prefsAutoCloseTimer);
    prefsAutoCloseTimer = setTimeout(() => {
      setPrefsOpen(false);
    }, 3000);
  };

  const cancelPrefsAutoClose = () => {
    if (!prefsAutoCloseTimer) return;
    clearTimeout(prefsAutoCloseTimer);
    prefsAutoCloseTimer = null;
  };

  const loadPrefs = () => {
    pickDefaultLayoutIfUnset();

    const rawTheme = localStorage.getItem(STORAGE.theme) || 'light';
    const theme = normalizeTheme(rawTheme);
    if (rawTheme !== theme) localStorage.setItem(STORAGE.theme, theme);
    setAttr(document.body, 'data-theme', theme);
    if (el.themeSelect) el.themeSelect.value = theme;
    syncDropdown(el.themeSelect, el.themeTrigger, el.themeMenu);

    const layout = localStorage.getItem(STORAGE.layout) || 'medium';
    setAttr(document.body, 'data-layout', layout);
    if (el.layoutSelect) el.layoutSelect.value = layout;
    syncDropdown(el.layoutSelect, el.layoutTrigger, el.layoutMenu);

    accentByTheme = readJSON(STORAGE.accentByTheme, {});
    const savedAccent = localStorage.getItem(STORAGE.accent);
    const accent = accentByTheme?.[theme] || (theme !== 'dark' ? savedAccent : null) || defaultAccentForTheme(theme);
    applyAccent(accent);

    orderByCat = readJSON(STORAGE.order, {});
    quickOrder = readJSON(STORAGE.quickOrder, []);
    recentIds = normalizeRecent(readJSON(STORAGE.recent, []));
    setRecentVisible(localStorage.getItem(STORAGE.recentVisible) === '1');

    const isCollapsed = localStorage.getItem(STORAGE.prefsCollapsed) !== '0';
    setPrefsOpen(!isCollapsed);
  };

  const resetAll = () => {
    Object.values(STORAGE).forEach(k => localStorage.removeItem(k));
    loadPrefs();
    render();
  };

  const bindEvents = () => {
    const syncSearchClear = () => {
      if (!el.searchClear || !el.searchInput) return;
      const hasText = (el.searchInput.value || '').length > 0;
      el.searchClear.toggleAttribute('data-visible', hasText);
      el.searchClear.setAttribute('aria-hidden', hasText ? 'false' : 'true');
    };

    el.searchInput?.addEventListener('input', () => {
      applyFilter();
      syncSearchClear();
    });
    el.searchInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        el.searchInput.value = '';
        applyFilter();
        syncSearchClear();
      }
    });
    el.searchClear?.addEventListener('click', () => {
      if (!el.searchInput) return;
      el.searchInput.value = '';
      applyFilter();
      syncSearchClear();
      el.searchInput.focus();
    });
    el.searchBox?.addEventListener('click', (e) => {
      if (!el.searchInput) return;
      if (e.target.closest('.search-clear')) return;
      el.searchInput.focus();
    });

    el.themeSelect?.addEventListener('change', () => {
      const nextTheme = el.themeSelect.value;
      setAttr(document.body, 'data-theme', nextTheme);
      localStorage.setItem(STORAGE.theme, nextTheme);
      applyAccent(accentByTheme?.[nextTheme] || defaultAccentForTheme(nextTheme));
      syncDropdown(el.themeSelect, el.themeTrigger, el.themeMenu);
      syncPrefsAnchor();
      schedulePrefsAutoClose();
    });

    el.layoutSelect?.addEventListener('change', () => {
      setAttr(document.body, 'data-layout', el.layoutSelect.value);
      localStorage.setItem(STORAGE.layout, el.layoutSelect.value);
      syncDropdown(el.layoutSelect, el.layoutTrigger, el.layoutMenu);
      applyFilter();
      syncPrefsAnchor();
      schedulePrefsAutoClose();
    });

    el.paletteBtn?.addEventListener('click', () => el.accentPicker?.click());
    el.accentPicker?.addEventListener('input', () => {
      const value = el.accentPicker.value;
      const theme = document.body.getAttribute('data-theme') || 'light';
      applyAccent(value);
      accentByTheme[theme] = value;
      localStorage.setItem(STORAGE.accentByTheme, JSON.stringify(accentByTheme));
      localStorage.setItem(STORAGE.accent, value);
      schedulePrefsAutoClose();
    });

    el.resetPrefs?.addEventListener('click', resetAll);
    el.recentToggleBtn?.addEventListener('click', () => {
      setRecentVisible(!showRecent);
      render();
      schedulePrefsAutoClose();
    });

    document.addEventListener('click', (e) => {
      if (Date.now() >= suppressTileClickUntil) return;
      if (!e.target.closest('.tile')) return;
      e.preventDefault();
      e.stopImmediatePropagation();
    }, true);

    document.addEventListener('dragstart', (e) => {
      if (!e.target.closest('.tile')) return;
      e.preventDefault();
    });

    document.addEventListener('click', (e) => {
      const tile = e.target.closest('.columns .tile[data-id]');
      if (!tile) return;
      trackRecent(tile.getAttribute('data-id'));
    });

    el.prefsToggleBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = document.body.getAttribute('data-prefs') === 'open';
      setPrefsOpen(!isOpen);
    });

    document.addEventListener('click', (e) => {
      closeDropdowns();
      if (document.body.getAttribute('data-prefs') !== 'open') return;
      if (!el.prefsDrawerEl?.contains(e.target)) setPrefsOpen(false);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      if (dropdownState.openMenu) {
        closeDropdowns();
        return;
      }
      if (document.body.getAttribute('data-prefs') === 'open') setPrefsOpen(false);
    });

    setupDropdown(el.themeSelect, el.themeTrigger, el.themeMenu);
    setupDropdown(el.layoutSelect, el.layoutTrigger, el.layoutMenu);
    syncSearchClear();

    el.prefsPanelEl?.addEventListener('click', (e) => e.stopPropagation());
    el.prefsPanelEl?.addEventListener('pointerdown', cancelPrefsAutoClose);
    el.prefsPanelEl?.addEventListener('focusin', cancelPrefsAutoClose);
    el.prefsPanelEl?.addEventListener('input', cancelPrefsAutoClose);
    window.addEventListener('resize', syncPrefsAnchor);
  };

  loadPrefs();
  bindEvents();
  render();
</script>
</body>
</html>
